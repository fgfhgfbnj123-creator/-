## 1. Файл з правилами YARA

На Linux:

1. Створюєш файл, наприклад `obfuscated.yar`
2. Вставляєш туди все, що нижче:

```yara
import "math"

rule LIB_SO_obfuscated    // обфусковані бібліотеки .so
{
    meta:
        description = "Підозріло обфускована ELF-бібліотека (.so)"
        filetype    = "ELF shared object"

    strings:
        $elf_magic = { 7F 45 4C 46 }          // сигнатура ELF
    condition:
        // ELF-заголовок і тип ET_DYN (shared object)
        $elf_magic at 0 and
        uint16(0x10) == 3 and                // e_type = 3 -> shared object
        filesize > 4096 and                  // нехай файл не надто маленький
        math.entropy(0, filesize) > 7.4      // висока ентропія -> обфускація/шифрування
}

rule ELF_console_obfuscated    // обфусковані консольні виконувані файли
{
    meta:
        description = "Підозріло обфускований ELF-виконуваний файл (консоль)"
        filetype    = "ELF executable"

    strings:
        $elf_magic = { 7F 45 4C 46 }
    condition:
        // ELF-заголовок і тип ET_EXEC (звичайний виконуваний файл)
        $elf_magic at 0 and
        uint16(0x10) == 2 and                // e_type = 2 -> executable
        filesize > 4096 and
        math.entropy(0, filesize) > 7.4
}

rule JPG_obfuscated
{
    meta:
        description = "JPG-файл з підозріло високою ентропією (можливе приховане ПЗ)"
        filetype    = "JPEG image"

    strings:
        $jpg_hdr = { FF D8 FF }              // сигнатура JPEG на початку файлу
    condition:
        $jpg_hdr at 0 and
        filesize > 4096 and
        math.entropy(0, filesize) > 7.6      // для картинок піднімаємо поріг
}

rule SVG_obfuscated
{
    meta:
        description = "SVG з підозрілими скриптами / base64 (можливе сховане ПЗ)"
        filetype    = "SVG image"

    strings:
        $svg_tag    = "<svg" ascii nocase
        $script_tag = "<script" ascii nocase
        $onload     = "onload=" ascii nocase
        $b64        = "base64," ascii nocase
    condition:
        // SVG повинен бути текстовим файлом, шукаємо теги у першому кілобайті
        $svg_tag in (0..1024) and
        (
            $script_tag or                       // вбудований JS-код
            $onload or                           // подія onload
            $b64                                 // довгі base64-дані всередині
        )
}

rule MKV_obfuscated
{
    meta:
        description = "MKV-файл з високою ентропією (можливе приховане ПЗ або шифрування)"
        filetype    = "Matroska video"

    strings:
        $ebml = { 1A 45 DF A3 }              // сигнатура EBML / MKV
    condition:
        $ebml at 0 and
        filesize > 1024 * 1024 and           // відео зазвичай досить велике
        math.entropy(0, filesize) > 7.8
}

## 2. Що робить кожне правило (коротко для звіту)

### 2.1. `LIB_SO_obfuscated`

* Перевіряє, що файл починається з магічної послідовності ELF (`7F 45 4C 46`).
* Читає два байти за зміщенням `0x10` – це поле `e_type` заголовка ELF.

  * Значення `3` означає **shared object** (динамічна бібліотека `.so`).
* Додаткові умови:

  * розмір файлу більше 4096 байт (відкидаємо сміття);
  * ентропія всього файлу `> 7.4` – файл сильно стиснутий / зашифрований / обфускований.

### 2.2. `ELF_console_obfuscated`

* Так само шукає ELF-заголовок.
* `uint16(0x10) == 2` – тип `ET_EXEC`, тобто **звичайний виконуваний файл** (консольний бінарник).
* Перевіряє розмір і високу ентропію.

Разом: перші два правила відділяють непрозорі, «зашумлені» ELF-бінарники і бібліотеки – типова ознака обфускації або упаковки (UPX, шифрування і т.п.).

### 2.3. `JPG_obfuscated`

* Перевіряє сигнатуру JPEG на початку (`FF D8 FF`).
* Працює тільки для файлів > 4 КБ.
* Якщо ентропія `> 7.6`, то це нетипово «щільний» JPEG – можливе приховання шкідливих даних стеганографією або шифруванням усередині.

### 2.4. `SVG_obfuscated`

* Переконується, що це текстовий SVG (`"<svg"` у перших байтах).
* Шукає:

  * теги `<script>` – вбудований JavaScript,
  * атрибут `onload=` – виконання коду при завантаженні,
  * підрядок `base64,` – великі вбудовані блоби закодованих даних.
* Якщо SVG містить хоч щось із цього – помічається як потенційно обфускований / шкідливий.

### 2.5. `MKV_obfuscated`

* Перевіряє сигнатуру контейнера Matroska (`1A 45 DF A3` на початку).
* Працює для файлів > 1 МБ.
* Ентропія `> 7.8` – дуже високий рівень випадковості. Для відео це часто означає сильну компресію або шифрування; якщо таке відео використовується як контейнер для схованих даних, правило його підсвічує.

---

## 3. Як запускати правила в Linux

### 3.1. Встановити YARA (якщо ще немає)

На Debian/Ubuntu:

```bash
sudo apt update
sudo apt install yara
```

На Fedora:

```bash
sudo dnf install yara
```

---

### 3.2. Запуск перевірки одного файлу

```bash
yara obfuscated.yar /path/to/file
```

Якщо файл збігається з якимось правилом, YARA виведе:

```text
ELF_console_obfuscated /path/to/file
```

---

### 3.3. Рекурсивна перевірка каталогу

```bash
yara -r obfuscated.yar /home/user/samples/
```

Ключ `-r` означає «recursive» – обходити підкаталоги.
